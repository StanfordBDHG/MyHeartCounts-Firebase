#
# This source file is part of the Stanford Biodesign Digital Health MyHeart Counts open-source project
#
# SPDX-FileCopyrightText: 2026 Stanford University and the project authors (see CONTRIBUTORS.md)
#
# SPDX-License-Identifier: MIT
#

name: Update Package Versions on Release

on:
  release:
    types: [published]

jobs:
  update-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}
          token: ${{ steps.app-token.outputs.token }}

      - name: Update root package.json
        uses: BellCubeDev/update-package-version-by-release-tag@v2
        with:
          package-json-path: "./package.json"

      - name: Update functions package.json
        uses: BellCubeDev/update-package-version-by-release-tag@v2
        with:
          package-json-path: "./functions/package.json"

      - name: Update models package.json
        uses: BellCubeDev/update-package-version-by-release-tag@v2
        with:
          package-json-path: "./functions/models/package.json"

      - name: Commit updated package.json files
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          APP_SLUG=$(gh api /app --jq '.slug' 2>/dev/null || echo "github-app")
          APP_USER_ID=$(gh api "/users/${APP_SLUG}[bot]" --jq '.id' 2>/dev/null || echo "")
          git config --local user.email "${APP_USER_ID}+${APP_SLUG}[bot]@users.noreply.github.com"
          git config --local user.name "${APP_SLUG}[bot]"
          git add package.json functions/package.json functions/models/package.json
          git diff --staged --quiet || git commit -m "chore: update version to ${{ github.event.release.tag_name }}"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ steps.app-token.outputs.token }}
          branch: ${{ github.event.release.target_commitish }}

      - name: Update release tag to version-bumped commit
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          NEW_SHA=$(git rev-parse HEAD)
          git tag -f ${{ github.event.release.tag_name }} $NEW_SHA
          git push -f origin ${{ github.event.release.tag_name }}
          gh release edit ${{ github.event.release.tag_name }} --target $NEW_SHA

      - name: Trigger deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deployment.yml',
              ref: '${{ github.event.release.target_commitish }}',
              inputs: {
                environment: 'production'
              }
            });
